---
title: 秒杀系统
date: 2025-06-26 15:54:07
tags:
---

# 秒杀系统

## 简历描述

高并发秒杀系统 - Golang
- 设计并实现基于 Go、Kafka、Etcd 的高并发秒杀系统，涵盖抢购下单、库存扣减、异步落库、排行榜等核心功能，单节点 QPS 3000，支持 K8s 3 节点集群部署。  
- 使用 Etcd 实现强一致分布式锁，结合 WAL 持久化记录锁状态（UUID + LeaseID），实现锁的自动续租与服务重启恢复机制，避免锁丢失与惊群问题。  
- 引入令牌桶限流与 Kafka 异步下单机制，将秒杀高峰削峰至 1000 QPS，结合 Redis 缓存库存预热策略，在3节点环境下，1000 QPS 持续 30 秒压测，总请求中约 20% 出现 429 限流，总成功率达 70%。  
- 实现 Redis ZSet 异步排行榜同步机制，使用 Kafka + Goroutine 将高并发更新操作异步解耦，排行榜更新时间控制在 100ms 以内。  
- 部署 Prometheus 和 Grafana，监控库存命中率、限流 QPS、Kafka 消费延迟等关键指标，保障系统性能与稳定。

## 问题

> 设计并实现基于 Go、Kafka、Etcd 的高并发秒杀系统，涵盖抢购下单、库存扣减、异步落库、排行榜等核心功能，单节点 QPS 3000，支持 K8s 3 节点集群部署。
1. **秒杀系统整体架构是怎样的？各组件之间如何通信？**
   - 系统架构包括前端请求处理、后端服务、消息队列（Kafka）、分布式锁（Etcd）和缓存（Redis）。前端通过 HTTP 请求与后端服务通信，后端服务使用 Kafka 处理异步下单请求，Etcd 用于分布式锁管理，Redis 用于缓存库存和排行榜数据。
   - 各组件之间通过 REST API 和消息队列进行通信，确保高并发并发下的解耦和异步处理。
   - 前端请求首先进入限流模块，使用令牌桶算法控制 QPS，然后将请求发送到后端服务。后端服务处理下单逻辑，使用 Etcd 获取分布式锁，确保库存扣减的原子性。成功后，将下单请求发送到 Kafka 进行异步处理，最后更新 Redis 中的库存和排行榜。
2. **单节点 QPS 3000 是如何测试的？测试工具和环境如何配置？**
   - 使用k6进行压力测试，配置了 1000 个虚拟用户并发请求，持续 30 秒。测试环境为单节点部署，使用 Docker 容器运行 Golang 服务，Kafka 和 Etcd 也在同一节点上运行。
3. **Kafka 在系统中的作用具体是什么？为什么不用 RabbitMQ？**
4. **Etcd 主要做什么？为什么不选 Redis 实现锁？**
5. **3 节点 K8s 部署是多台物理机还是单机模拟？调度策略怎么做的？**
6. **下单、扣库存、落库、排行榜之间是串行的还是异步解耦的？**
7. **高并发下如何避免超卖和重复下单？**
8. **如何做多副本部署时的服务注册与发现？**

> 使用 Etcd 实现强一致分布式锁，结合 WAL 持久化记录锁状态（UUID + LeaseID），实现锁的自动续租与服务重启恢复机制，避免锁丢失与惊群问题。

1. **为什么选用 Etcd 做分布式锁，而不是 Redis？**
2. **你是如何使用 LeaseID 做自动续租的？是否会续租失败？**
3. **什么是 WAL（Write-Ahead Log）？你怎么实现落盘和恢复的？**
4. **如果服务意外崩溃，如何保证锁的状态不会丢失？**
5. **什么是惊群问题？Etcd 如何避免？**
6. **你们有没有考虑锁饥饿、死锁的情况？**
7. **Lease 到期前锁失效怎么办？是否会误删其他节点的锁？**

> 引入令牌桶限流与 Kafka 异步下单机制，将秒杀高峰削峰至 1000 QPS，结合 Redis 缓存库存预热策略，在 3 节点环境下，1000 QPS 持续 30 秒压测，总请求中约 20% 出现 429 限流，总成功率达 70%。

1. **为什么用令牌桶限流而不是漏桶？限流粒度是 IP 级还是全局？**
2. **你是如何设置令牌生成速率和桶容量的？**
3. **Kafka 下单异步流程怎么保证消息不丢？用了哪些配置？**
4. **Redis 缓存库存是怎么预热的？预热策略是什么？怎么回源？**
5. **为什么 429 限流率这么高？是否考虑更细化限流策略？**
6. **成功率 70% 是针对所有请求吗？剩下 30% 是失败还是限流？**
7. **压测用的是什么工具？并发模型是怎样的？**
8. **如果 Kafka 消费延迟了，会导致库存错误吗？如何避免重复消费？**
9. **如何保证 Kafka 消息幂等？是否使用了唯一 ID 或幂等键？**

> 实现 Redis ZSet 异步排行榜同步机制，使用 Kafka + Goroutine 将高并发更新操作异步解耦，排行榜更新时间控制在 100ms 以内。

1. **排行榜的业务目的是什么？展示什么指标？**
2. **为什么使用 Redis ZSet？ZSet 是怎么构造 key 和 score 的？**
3. **异步同步具体是怎么做的？Kafka 消息如何转成 ZSet 操作？**
4. **Kafka 消费慢了怎么办？是否有批量处理优化？**
5. **排行榜更新频率高怎么做并发控制？**
6. **为什么控制在 100ms 以内？这个数据怎么测出来的？**
7. **Redis 高并发写入是否考虑分片或持久化压力？**

> 部署 Prometheus 和 Grafana，监控库存命中率、限流 QPS、Kafka 消费延迟等关键指标，保障系统性能与稳定。

1. **你们用的哪些指标做系统监控？Prometheus 是如何采集这些指标的？**
2. **限流 QPS 如何暴露为指标？是通过 middleware 中间件采集的吗？**
3. **Kafka 消费延迟是怎么算的？是消费时间减生产时间吗？**
4. **库存命中率是如何定义和记录的？从 Redis 采集吗？**
5. **有设置告警吗？什么阈值下触发告警？**
6. **Grafana 展示的关键仪表盘有哪些？**
7. **是否有做分布式链路追踪（如 Jaeger）？对定位性能瓶颈是否有帮助？**
